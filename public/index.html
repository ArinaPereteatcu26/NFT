
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Luna AR NFT Experience</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>
    <!-- AR.js NFT -->
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

    <style>
        body { margin:0; overflow:hidden; font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }
        #ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 10px 14px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.75), rgba(0,0,0,0));
            color: #fff;
            font-size: 13px;
            z-index: 10;
        }
        #ui-overlay h1 {
            margin: 0 0 4px 0;
            font-size: 15px;
        }
        #ui-overlay p {
            margin: 0;
            line-height: 1.3;
        }
    </style>
</head>

<body>
<div id="ui-overlay">
    <h1>üêæ Luna, the Portal Cat</h1>
    <p>1Ô∏è‚É£ Point the camera at your NFT marker with the cat image.<br/>
        2Ô∏è‚É£ When Luna appears, tap on the screen to continue the story.<br/>
        3Ô∏è‚É£ Watch her world transform as you interact.</p>
</div>

<a-scene
        embedded
        vr-mode-ui="enabled: false"
        renderer="colorManagement: true; physicallyCorrectLights: true"
        arjs="sourceType: webcam; trackingMethod: best; debugUIEnabled: false"
>

    <!-- Lights -->
    <a-entity light="type: ambient; intensity: 1"></a-entity>
    <a-entity light="type: directional; intensity: 0.9" position="1 1 1"></a-entity>

    <!-- NFT Marker
         IMPORTANT:
         Put your marker files in a folder called "luna-marker" next to this index.html:
         luna-marker.fset, luna-marker.fset3, luna-marker.iset

         Then keep url="./luna-marker/luna-marker"
    -->
    <a-nft
            id="catMarker"
            type="nft"
            url="./luna-marker/luna-cat">

        <!-- Main card with the anime cat image -->
        <a-plane
                id="catCard"
                position="0 0 0"
                rotation="-90 0 0"
                width="1.2"
                height="1.2"
                material="
                src: url(./luna-cat.png);
                opacity: 0.95;
                transparent: true;
                shader: standard;
                emissive: #ff8ad9;
                emissiveIntensity: 0.6;">
        </a-plane>

        <!-- Soft glowing aura around the card -->
        <a-ring id="aura"
                position="0 0 0"
                rotation="-90 0 0"
                radius-inner="0.7"
                radius-outer="0.9"
                material="color: #ffb3ec; opacity: 0.7; transparent: true"
                animation__pulse_scale="
                    property: scale;
                    from: 1 1 1;
                    to: 1.15 1.15 1.15;
                    dir: alternate;
                    loop: true;
                    dur: 1400"
                animation__pulse_opacity="
                    property: material.opacity;
                    from: 0.4;
                    to: 0.9;
                    dir: alternate;
                    loop: true;
                    dur: 1400">
        </a-ring>

        <!-- Story text -->
        <a-text id="storyText"
                value="üì∏ Scan the cat marker
to wake up Luna."
                color="#ffd6ff"
                align="center"
                position="0 0.8 0.1"
                rotation="-90 0 0"
                width="2"
                shader="msdf"
                negate="false">
        </a-text>

        <!-- Small stars for Luna's dream world (hidden at first) -->
        <a-entity id="stars" visible="false">
            <a-sphere radius="0.05" position="-0.5 0.2 0.2" material="color: #fff5ff; emissive: #ffc8ff; emissiveIntensity: 0.8;"></a-sphere>
            <a-sphere radius="0.04" position="0.4 0.1 -0.1" material="color: #e0f0ff; emissive: #9fd7ff; emissiveIntensity: 0.8;"></a-sphere>
            <a-sphere radius="0.03" position="0.1 0.3 0.3" material="color: #ffe4ff; emissive: #ff9df2; emissiveIntensity: 0.9;"></a-sphere>
        </a-entity>

        <!-- Portal that replaces the card in phase 2 -->
        <a-torus-knot id="portal"
                      visible="false"
                      radius="0.45"
                      radius-tubular="0.12"
                      position="0 0 0.15"
                      rotation="0 0 0"
                      material="
                        color: #ff8ad9;
                        emissive: #b57dff;
                        opacity: 0.85;
                        transparent: true;
                        metalness: 0.2;
                        roughness: 0.1;"
                      animation__spin="property: rotation; to: 0 360 0; loop: true; dur: 3500">
        </a-torus-knot>

        <!-- Floating heart that appears in the final phase -->
        <a-sphere id="heart"
                  visible="false"
                  radius="0.12"
                  position="0 0.5 0.25"
                  material="color: #ff4f94; emissive: #ff99c9; emissiveIntensity: 0.9; opacity: 0.95; transparent: true;"
                  animation__float="
                    property: position;
                    from: 0 0.4 0.25;
                    to: 0 0.7 0.25;
                    dir: alternate;
                    loop: true;
                    dur: 1200">
        </a-sphere>

    </a-nft>

    <!-- Camera -->
    <a-entity camera></a-entity>
</a-scene>

<script>
    const marker = document.getElementById("catMarker");
    const catCard = document.getElementById("catCard");
    const aura = document.getElementById("aura");
    const storyText = document.getElementById("storyText");
    const stars = document.getElementById("stars");
    const portal = document.getElementById("portal");
    const heart = document.getElementById("heart");

    let markerVisible = false;
    let catAwake = false;
    let phase = 0; // 0 = wake up, 1 = dream, 2 = portal world
    let messageIndex = 0;

    const phase0Messages = [
        "üì∏ Luna just woke up in your world.",
        "üê± \"Hey, I like your dimension...\"",
        "üíï \"But my dream world is even prettier.\"",
        "‚ú® Tap again to help Luna open a portal."
    ];

    const phase1Messages = [
        "üåô \"First, fill my sky with tiny stars.\"",
        "üí´ Tap again to light up Luna's dream."
    ];

    const phase2Messages = [
        "üåÄ The portal to Luna's world is open.",
        "üåå \"Here, anxiety turns into constellations.\"",
        "üíñ \"Every worry becomes a small, soft star.\"",
        "üêæ Tap again to send Luna a heart."
    ];

    const phase3Messages = [
        "üíù \"Thank you for visiting my world.\"",
        "üì∑ You can screenshot this moment as Luna's NFT memory.",
        "üêæ Tap again to replay from the beginning."
    ];


    marker.addEventListener('markerFound', () => {
        markerVisible = true;
        catAwake = true;
        if (phase === 0 && messageIndex === 0) {
            storyText.setAttribute('value', phase0Messages[0]);
        }
    });

    marker.addEventListener('markerLost', () => {
        markerVisible = false;
    });

    function setCardVisible(isVisible) {
        catCard.setAttribute('visible', isVisible);
        aura.setAttribute('visible', isVisible);
    }

    document.body.addEventListener('click', () => {
        if (!markerVisible || !catAwake) return;

        // Phase 0: Wake-up dialogue on the card
        if (phase === 0) {
            messageIndex = (messageIndex + 1);
            if (messageIndex < phase0Messages.length) {
                storyText.setAttribute('value', phase0Messages[messageIndex]);
            } else {
                phase = 1;
                messageIndex = 0;
                storyText.setAttribute(
                    'value',
                    "üåô Luna: \"Okay, now let's dream bigger.\"\nTap to see the stars appear."
                );

            }
        }
        // Phase 1: Stars appear around the card
        else if (phase === 1) {
            stars.setAttribute('visible', true);
            storyText.setAttribute('value', phase1Messages[0]);
            phase = 2;
            messageIndex = 0;
        }
        // Phase 2: Switch from card to portal world
        else if (phase === 2) {
            setCardVisible(false);
            stars.setAttribute('visible', true);
            portal.setAttribute('visible', true);
            storyText.setAttribute('value', phase2Messages[0]);
            phase = 2.5;
            messageIndex = 0;
        }
        // Phase 2.5: Interact with the portal, cycle messages and colors
        else if (phase === 2.5) {
            messageIndex = (messageIndex + 1) % phase2Messages.length;
            storyText.setAttribute('value', phase2Messages[messageIndex]);

            // Slightly change portal color/emissive each tap
            const colors = ["#ff8ad9", "#ffb347", "#8ad9ff", "#c38dff"];
            const emissives = ["#b57dff", "#ff9dbb", "#7dc9ff", "#ff9df2"];
            const idx = messageIndex % colors.length;
            portal.setAttribute('material',
                "color: " + colors[idx] +
                "; emissive: " + emissives[idx] +
                "; opacity: 0.9; transparent: true; metalness: 0.2; roughness: 0.1;"
            );

            // After full cycle, move to heart phase
            if (messageIndex === phase2Messages.length - 1) {
                phase = 3;
                messageIndex = 0;
                storyText.setAttribute('value', "üíñ Tap again to send Luna a glowing heart.");
            }
        }
        // Phase 3: Heart appears
        else if (phase === 3) {
            heart.setAttribute('visible', true);
            storyText.setAttribute('value', phase3Messages[0]);
            phase = 3.5;
            messageIndex = 0;
        }
        // Phase 3.5: Ending + replay
        else if (phase === 3.5) {
            messageIndex = (messageIndex + 1);
            if (messageIndex < phase3Messages.length) {
                storyText.setAttribute('value', phase3Messages[messageIndex]);
            } else {
                // Reset everything to initial state
                phase = 0;
                messageIndex = 0;
                setCardVisible(true);
                stars.setAttribute('visible', false);
                portal.setAttribute('visible', false);
                heart.setAttribute('visible', false);
                storyText.setAttribute('value', "üì∏ Scan the cat marker\nto wake up Luna again.");
            }
        }
    });
</script>

</body>
</html>
