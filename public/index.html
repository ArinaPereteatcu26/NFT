<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <title>Nyan Cat's Space Journey</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>

    <!-- AR.js NFT -->
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.js"></script>

    <style>
        * { margin: 0; padding: 0; }
        body { overflow: hidden; }

        #debugStatus {
            position: fixed;
            bottom: 15px;
            left: 15px;
            padding: 12px 18px;
            font-size: 14px;
            background: rgba(255, 0, 0, 0.85);
            color: white;
            border-radius: 25px;
            z-index: 9999;
            font-family: 'Segoe UI', sans-serif;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        #storyText {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 25px;
            font-size: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 30px;
            z-index: 9999;
            font-family: 'Segoe UI', sans-serif;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            text-align: center;
            max-width: 80%;
            opacity: 0;
            transition: opacity 0.5s ease;
        }

        #storyText.visible {
            opacity: 1;
        }

        #tapHint {
            position: fixed;
            bottom: 80px;
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            font-size: 14px;
            background: rgba(255, 255, 255, 0.9);
            color: #333;
            border-radius: 20px;
            z-index: 9999;
            font-family: 'Segoe UI', sans-serif;
            animation: pulse 1.5s infinite;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #tapHint.visible {
            opacity: 1;
        }

        @keyframes pulse {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.05); }
        }

        #progressBar {
            position: fixed;
            top: 80px;
            left: 50%;
            transform: translateX(-50%);
            width: 200px;
            height: 8px;
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
            z-index: 9999;
            overflow: hidden;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #progressBar.visible {
            opacity: 1;
        }

        #progressFill {
            height: 100%;
            width: 0%;
            background: linear-gradient(90deg, #ff0080, #ff8c00, #40e0d0);
            border-radius: 10px;
            transition: width 0.5s ease;
        }
    </style>
</head>

<body>

<div id="debugStatus">üîç Point camera at Nyan marker</div>
<div id="storyText"></div>
<div id="tapHint">üëÜ Tap to continue</div>
<div id="progressBar"><div id="progressFill"></div></div>

<a-scene
        embedded
        arjs="sourceType: webcam; trackingMethod: best; debugUIEnabled: false;"
        renderer="logarithmicDepthBuffer: true; antialias: true;"
        vr-mode-ui="enabled: false">

    <a-assets>
        <img id="nyanImg" src="./nyan.png" crossorigin="anonymous">
    </a-assets>

    <!-- MAIN MARKER -->
    <a-nft id="nyanMarker"
           type="nft"
           url="./nyan-marker/nyan">
        <!-- STAGE 1: Nyan Cat with rainbow trail -->
        <a-entity id="stage1" visible="false">
            <!-- Rainbow trail -->
            <a-box position="-0.8 0 0" width="0.15" height="0.08" depth="0.6" color="#FF0000" rotation="-90 0 0"></a-box>
            <a-box position="-0.8 0 0.1" width="0.15" height="0.08" depth="0.6" color="#FF7F00" rotation="-90 0 0"></a-box>
            <a-box position="-0.8 0 0.2" width="0.15" height="0.08" depth="0.6" color="#FFFF00" rotation="-90 0 0"></a-box>
            <a-box position="-0.8 0 0.3" width="0.15" height="0.08" depth="0.6" color="#00FF00" rotation="-90 0 0"></a-box>
            <a-box position="-0.8 0 0.4" width="0.15" height="0.08" depth="0.6" color="#0000FF" rotation="-90 0 0"></a-box>
            <a-box position="-0.8 0 0.5" width="0.15" height="0.08" depth="0.6" color="#8B00FF" rotation="-90 0 0"></a-box>

            <!-- Nyan Cat -->
            <a-image src="#nyanImg"
                     rotation="-90 0 0"
                     position="0 0 0.25"
                     width="1.0" height="1.0"
                     animation="property: position; from: -1 0 0.25; to: 0 0 0.25; dur: 1000; easing: easeOutBack">
            </a-image>
        </a-entity>

        <!-- STAGE 2: Magical Portal -->
        <a-entity id="stage2" visible="false">
            <a-torus-knot
                    radius="0.35"
                    radius-tubular="0.08"
                    rotation="0 0 0"
                    position="0 0 0.3"
                    material="color: #FF00FF; emissive: #FF00FF; emissiveIntensity: 0.5"
                    animation="property: rotation; to: 360 360 0; loop: true; dur: 3000; easing: linear">
            </a-torus-knot>

            <!-- Portal glow rings -->
            <a-ring position="0 0 0.3" radius-inner="0.25" radius-outer="0.3" color="#00FFFF" rotation="-90 0 0"
                    animation="property: scale; from: 0.8 0.8 0.8; to: 1.2 1.2 1.2; loop: true; dur: 1000; dir: alternate">
            </a-ring>
            <a-ring position="0 0 0.35" radius-inner="0.35" radius-outer="0.4" color="#FF69B4" rotation="-90 0 0"
                    animation="property: scale; from: 1 1 1; to: 1.3 1.3 1.3; loop: true; dur: 1200; dir: alternate">
            </a-ring>
        </a-entity>

        <!-- STAGE 3: Space with Planet -->
        <a-entity id="stage3" visible="false">
            <!-- Main Planet -->
            <a-sphere id="mainPlanet"
                      radius="0.4"
                      position="0 0 0.4"
                      material="color: #4CC3D9; metalness: 0.3; roughness: 0.7"
                      animation="property: rotation; to: 0 360 0; loop: true; dur: 8000; easing: linear">
            </a-sphere>

            <!-- Planet ring -->
            <a-torus position="0 0 0.4" radius="0.6" radius-tubular="0.03"
                     rotation="-90 20 0" color="#FFD700"
                     animation="property: rotation; from: -90 20 0; to: -90 380 0; loop: true; dur: 10000; easing: linear">
            </a-torus>

            <!-- Orbiting moons -->
            <a-entity animation="property: rotation; to: 0 360 0; loop: true; dur: 4000; easing: linear" position="0 0 0.4">
                <a-sphere radius="0.08" position="0.7 0 0" color="#FFFFFF"></a-sphere>
            </a-entity>
            <a-entity animation="property: rotation; to: 0 -360 0; loop: true; dur: 6000; easing: linear" position="0 0 0.4">
                <a-sphere radius="0.06" position="0.9 0.1 0" color="#FFA500"></a-sphere>
            </a-entity>
            <!-- Stars -->
            <a-sphere position="0.5 0.3 0.2" radius="0.02" color="#FFFFFF"
                      animation="property: material.opacity; from: 0.3; to: 1; loop: true; dur: 500; dir: alternate"></a-sphere>
            <a-sphere position="-0.4 0.2 0.1" radius="0.025" color="#FFFFFF"
                      animation="property: material.opacity; from: 0.5; to: 1; loop: true; dur: 700; dir: alternate"></a-sphere>
            <a-sphere position="0.3 -0.3 0.3" radius="0.02" color="#FFFFFF"
                      animation="property: material.opacity; from: 0.4; to: 1; loop: true; dur: 600; dir: alternate"></a-sphere>
            <a-sphere position="-0.5 -0.2 0.2" radius="0.03" color="#FFFFFF"
                      animation="property: material.opacity; from: 0.6; to: 1; loop: true; dur: 800; dir: alternate"></a-sphere>
        </a-entity>

        <!-- STAGE 4: Nyan's Home -->
        <a-entity id="stage4" visible="false">
            <!-- Home planet -->
            <a-sphere radius="0.5" position="0 0 0.5"
                      material="color: #FF69B4; emissive: #FF1493; emissiveIntensity: 0.3"
                      animation="property: rotation; to: 0 360 0; loop: true; dur: 10000">
            </a-sphere>

            <!-- Pop-Tart houses -->
            <a-box position="0.2 0.4 0.3" width="0.15" height="0.1" depth="0.1" color="#FFB6C1" rotation="0 30 0"></a-box>
            <a-box position="-0.15 0.35 0.4" width="0.12" height="0.08" depth="0.08" color="#FFC0CB" rotation="0 -20 0"></a-box>

            <!-- Nyan returns! -->
            <a-image src="#nyanImg"
                     rotation="-90 0 0"
                     position="0 0.6 0.3"
                     width="0.6" height="0.6"
                     animation="property: position; from: 1 0.6 0.3; to: 0 0.6 0.3; dur: 1500; easing: easeOutBounce">
            </a-image>

            <!-- Celebration particles -->
            <a-sphere position="0.3 0.5 0.2" radius="0.03" color="#FF0000"
                      animation="property: position; from: 0.3 0.3 0.2; to: 0.3 0.7 0.2; loop: true; dur: 1000"></a-sphere>
            <a-sphere position="-0.2 0.4 0.3" radius="0.025" color="#00FF00"
                      animation="property: position; from: -0.2 0.2 0.3; to: -0.2 0.6 0.3; loop: true; dur: 1200"></a-sphere>
            <a-sphere position="0.1 0.5 0.4" radius="0.03" color="#0000FF"
                      animation="property: position; from: 0.1 0.3 0.4; to: 0.1 0.7 0.4; loop: true; dur: 900"></a-sphere>
            <a-sphere position="-0.3 0.45 0.25" radius="0.02" color="#FFFF00"
                      animation="property: position; from: -0.3 0.25 0.25; to: -0.3 0.65 0.25; loop: true; dur: 1100"></a-sphere>
        </a-entity>

        <!-- STAGE 5: Final Message -->
        <a-entity id="stage5" visible="false">
            <!-- Rainbow background sphere -->
            <a-sphere radius="0.8" position="0 0 0.4"
                      material="color: #1a1a2e; side: back; opacity: 0.9">
            </a-sphere>

            <!-- Nyan celebration -->
            <a-image src="#nyanImg"
                     rotation="-90 0 0"
                     position="0 0 0.4"
                     width="0.8" height="0.8"
                     animation="property: rotation; from: -90 0 -5; to: -90 0 5; loop: true; dur: 300; dir: alternate">
            </a-image>
            <!-- Fireworks -->
            <a-sphere position="0.4 0.3 0.3" radius="0.04" color="#FF0080"
                      animation="property: scale; from: 0.5 0.5 0.5; to: 1.5 1.5 1.5; loop: true; dur: 600; dir: alternate"></a-sphere>
            <a-sphere position="-0.35 0.25 0.35" radius="0.035" color="#00FFFF"
                      animation="property: scale; from: 0.5 0.5 0.5; to: 1.5 1.5 1.5; loop: true; dur: 500; dir: alternate"></a-sphere>
            <a-sphere position="0.2 -0.3 0.3" radius="0.04" color="#FFFF00"
                      animation="property: scale; from: 0.5 0.5 0.5; to: 1.5 1.5 1.5; loop: true; dur: 700; dir: alternate"></a-sphere>
            <a-sphere position="-0.25 -0.2 0.4" radius="0.03" color="#FF4500"
                      animation="property: scale; from: 0.5 0.5 0.5; to: 1.5 1.5 1.5; loop: true; dur: 550; dir: alternate"></a-sphere>
        </a-entity>

    </a-nft>

    <a-entity camera></a-entity>
</a-scene>

<script>
    const marker = document.getElementById("nyanMarker");
    const dbg = document.getElementById("debugStatus");
    const storyText = document.getElementById("storyText");
    const tapHint = document.getElementById("tapHint");
    const progressBar = document.getElementById("progressBar");
    const progressFill = document.getElementById("progressFill");

    const stages = [
        document.getElementById("stage1"),
        document.getElementById("stage2"),
        document.getElementById("stage3"),
        document.getElementById("stage4"),
        document.getElementById("stage5")
    ];

    const storyMessages = [
        "üê± Nyan Cat appears from the rainbow dimension!",
        "‚ú® A magical portal opens... tap to enter!",
        "üåç You've reached outer space! Tap the planet!",
        "üè† Welcome to Nyan's pink home planet!",
        "üéâ THE END - Nyan Cat thanks you for the journey!"
    ];

    let currentStage = -1;
    let markerVisible = false;
    let canTap = false;

    function showStage(index) {
        // Hide all stages
        stages.forEach((s, i) => {
            if (s) s.setAttribute("visible", i === index);
        });

        // Update story text
        storyText.textContent = storyMessages[index];
        storyText.classList.add("visible");

        // Update progress bar
        progressBar.classList.add("visible");
        progressFill.style.width = ((index + 1) / stages.length * 100) + "%";

        // Show tap hint for interactive stages (1, 2, 3)
        if (index === 1 || index === 2 || index === 3) {
            setTimeout(() => {
                tapHint.classList.add("visible");
                canTap = true;
            }, 1500);
        } else {
            tapHint.classList.remove("visible");
            canTap = false;
        }

        currentStage = index;
    }

    // Marker found
    marker.addEventListener("markerFound", () => {
        markerVisible = true;
        dbg.style.background = "linear-gradient(135deg, #11998e 0%, #38ef7d 100%)";
        dbg.textContent = "‚úÖ Marker detected!";

        if (currentStage === -1) {
            // Start the story
            showStage(0);

            // Auto-advance to portal after 4 seconds
            setTimeout(() => {
                if (currentStage === 0 && markerVisible) {
                    showStage(1);
                }
            }, 4000);
        }
    });

    // Marker lost
    marker.addEventListener("markerLost", () => {
        markerVisible = false;
        dbg.style.background = "rgba(255, 0, 0, 0.85)";
        dbg.textContent = "üîç Point camera at Nyan marker";
    });

    // Tap interactions
    document.body.addEventListener("click", () => {
        if (!canTap || !markerVisible) return;

        canTap = false;
        tapHint.classList.remove("visible");

        if (currentStage === 1) {
            // Portal ‚Üí Space
            showStage(2);
        } else if (currentStage === 2) {
            // Space ‚Üí Home
            showStage(3);
        } else if (currentStage === 3) {
            // Home ‚Üí Final
            showStage(4);
        }
    });

    // Restart on long press (optional)
    let pressTimer;
    document.body.addEventListener("touchstart", () => {
        pressTimer = setTimeout(() => {
            if (currentStage === 4) {
                currentStage = -1;
                storyText.classList.remove("visible");
                progressBar.classList.remove("visible");
                tapHint.classList.remove("visible");
                stages.forEach(s => s && s.setAttribute("visible", false));
                dbg.textContent = "üîÑ Restarting... point at marker";
            }
        }, 2000);
    });
    document.body.addEventListener("touchend", () => clearTimeout(pressTimer));
</script>

</body>
</html>