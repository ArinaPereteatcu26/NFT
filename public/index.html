<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Nyan Cat AR Adventure</title>

    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>

    <!-- AR.js NFT -->
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.js"></script>

    <style>
        body { margin: 0; overflow: hidden; }

        .arjs-loader {
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0; left: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .arjs-loader div {
            color: white;
            font-size: 1.4em;
            font-family: sans-serif;
        }

        #storyBox {
            position: fixed;
            top: 20px; left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.75);
            padding: 15px 25px;
            color: white;
            font-family: Arial, sans-serif;
            border-radius: 15px;
            text-align: center;
            max-width: 85%;
            font-size: 16px;
            z-index: 9999;
            opacity: 0;
            transition: opacity .5s ease;
        }
        #storyBox.visible { opacity: 1; }

        #tapHint {
            position: fixed;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.9);
            padding: 10px 20px;
            border-radius: 20px;
            color: #222;
            font-family: Arial;
            font-size: 14px;
            opacity: 0;
            z-index: 9999;
            transition: opacity .3s ease;
        }
        #tapHint.visible { opacity: 1; }

        #stepIndicator {
            position: fixed;
            top: 75px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
            opacity: 0;
            z-index: 9999;
            transition: opacity .3s ease;
        }
        #stepIndicator.visible { opacity: 1; }

        .step-dot {
            width: 12px; height: 12px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transition: background .3s ease;
        }
        .step-dot.active { background: #00ff88; }
    </style>
</head>

<body>

<div class="arjs-loader"><div>Loading AR Sceneâ€¦</div></div>

<div id="storyBox"></div>
<div id="stepIndicator">
    <div class="step-dot"></div>
    <div class="step-dot"></div>
    <div class="step-dot"></div>
    <div class="step-dot"></div>
    <div class="step-dot"></div>
</div>
<div id="tapHint">Tap to continue</div>

<a-scene
        embedded
        vr-mode-ui="enabled:false"
        renderer="logarithmicDepthBuffer:true;"
        arjs="trackingMethod:best; sourceType:webcam; debugUIEnabled:false;"
>
    <a-assets>
        <img id="nyanImg" src="./nyan.png">
    </a-assets>

    <!-- NFT MARKER -->
    <a-nft
            type="nft"
            url="./nyan-marker/nyan"
            smooth="true"
            smoothCount="10"
            smoothTolerance="0.01"
            smoothThreshold="5"
    >
        <!-- STEP 1: Nyan Cat appears -->
        <a-entity id="step1" visible="false">
            <a-image src="#nyanImg"
                     position="50 120 0"
                     rotation="-90 0 0"
                     scale="90 90 90">
            </a-image>
        </a-entity>

        <!-- Step 2: Pixel Portal (Cute 8-bit style) -->
        <a-entity id="step2" visible="false">

            <!-- Outer glow halo -->
            <a-image
                    src="./portal-glow.png"
                    position="50 150 0"
                    rotation="-90 0 0"
                    scale="150 150 150"
                    opacity="0.9"
                    animation="property: scale; from: 140 140 140; to: 160 160 160; loop: true; dur: 1500; dir: alternate; easing: easeInOutSine"
            ></a-image>

            <!-- Pixel-art ring -->
            <a-image
                    src="./portal-pixel.png"
                    position="50 150 1"
                    rotation="-90 0 0"
                    scale="120 120 120"
                    animation="property: rotation; to: -90 360 0; loop: true; dur: 4500; easing: linear"
            ></a-image>

        </a-entity>

        <!-- STEP 3: Planet, ring, space objects -->
        <a-entity id="step3" visible="false">
            <a-sphere radius="55" color="#3A6EFF"
                      position="50 130 0"
                      animation="property:rotation; to:0 360 0; loop:true; dur:7000;">
            </a-sphere>

            <a-torus radius="85" radius-tubular="4"
                     color="#FEE77A"
                     rotation="60 0 0"
                     position="50 130 0"
                     animation="property:rotation; to:60 360 0; loop:true; dur:5000;">
            </a-torus>

            <a-sphere radius="12" position="-20 150 20" color="#FFD700"></a-sphere>
            <a-sphere radius="10" position="120 160 -10" color="#FFFFFF"></a-sphere>
        </a-entity>

        <!-- STEP 4: Celebration â€” fireworks + bouncing Nyan -->
        <a-entity id="step4" visible="false">
            <a-image src="#nyanImg"
                     position="50 140 0"
                     rotation="-90 0 0"
                     scale="110 110 110"
                     animation="property:rotation; dir:alternate; from:-90 -5 0; to:-90 5 0; dur:300; loop:true;">
            </a-image>

            <a-sphere color="#FF00AA" radius="14" position="100 190 30"
                      animation="property:scale; dir:alternate; from:0.5 0.5 0.5; to:1.4 1.4 1.4; loop:true; dur:500;">
            </a-sphere>
            <a-sphere color="#00FFFF" radius="12" position="-30 170 40"
                      animation="property:scale; dir:alternate; from:0.5 0.5 0.5; to:1.4 1.4 1.4; loop:true; dur:600;">
            </a-sphere>
            <a-sphere color="#FFFF00" radius="16" position="50 200 -20"
                      animation="property:scale; dir:alternate; from:0.5 0.5 0.5; to:1.8 1.8 1.8; loop:true; dur:450;">
            </a-sphere>
        </a-entity>

    </a-nft>

    <a-entity camera></a-entity>
</a-scene>

<script>
    // Story script text
    const storySteps = [
        "Scan the image to begin the adventure...",
        "âœ¨ Nyan Cat awakens from the cosmic void!",
        "ðŸŒˆ Riding a rainbow between worlds...",
        "ðŸª A mysterious planet appears in deep space...",
        "ðŸŽ‰ Celebration! Nyan thanks you for journeying together!"
    ];

    let currentStep = 0;
    let markerFound = false;

    const storyBox = document.getElementById("storyBox");
    const tapHint = document.getElementById("tapHint");
    const stepIndicator = document.getElementById("stepIndicator");
    const dots = document.querySelectorAll(".step-dot");

    const stepEntities = [
        null,
        document.getElementById("step1"),
        document.getElementById("step2"),
        document.getElementById("step3"),
        document.getElementById("step4")
    ];

    function showStep(i) {
        currentStep = i;
        storyBox.textContent = storySteps[i];
        storyBox.classList.add("visible");
        stepIndicator.classList.add("visible");

        // highlight dots
        dots.forEach((d, x) => d.classList.toggle("active", x <= i));

        // show/hide 3D objects
        stepEntities.forEach((ent, idx) => {
            if (ent) ent.setAttribute("visible", idx === i);
        });

        if (i < storySteps.length - 1) {
            tapHint.classList.add("visible");
        } else {
            tapHint.classList.remove("visible");
        }
    }

    // Advance story
    function nextStep() {
        if (currentStep < storySteps.length - 1) {
            tapHint.classList.remove("visible");
            showStep(currentStep + 1);
        }
    }

    // Marker detection
    document.querySelector("a-nft").addEventListener("markerFound", () => {
        if (!markerFound) {
            markerFound = true;
            showStep(1);
        }
    });

    // Tap to continue
    document.body.addEventListener("click", () => {
        if (markerFound && currentStep >= 1) nextStep();
    });
</script>

</body>
</html>
