<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Nyan Cat AR Adventure</title>

    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.6.0/aframe.min.js"></script>

    <!-- AR.js NFT -->
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar-nft.js"></script>

    <style>
        body { margin: 0; overflow: hidden; }

        .arjs-loader {
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0; left: 0;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .arjs-loader div {
            color: white;
            font-size: 1.3em;
            font-family: system-ui, sans-serif;
        }

        #storyBox {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.78);
            padding: 14px 20px;
            color: #fff;
            font-family: system-ui, sans-serif;
            border-radius: 14px;
            text-align: center;
            max-width: 85%;
            font-size: 15px;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        #storyBox.visible { opacity: 1; }

        #tapHint {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.92);
            padding: 9px 18px;
            border-radius: 20px;
            color: #222;
            font-family: system-ui, sans-serif;
            font-size: 13px;
            opacity: 0;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }
        #tapHint.visible { opacity: 1; }

        #stepIndicator {
            position: fixed;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 6px;
            opacity: 0;
            z-index: 9999;
            transition: opacity 0.3s ease;
        }
        #stepIndicator.visible { opacity: 1; }

        .step-dot {
            width: 11px;
            height: 11px;
            border-radius: 50%;
            background: rgba(255,255,255,0.3);
            transition: background 0.25s ease;
        }
        .step-dot.active {
            background: #00ff99;
        }
    </style>
</head>

<body>
<!-- Loader while descriptors load -->
<div class="arjs-loader"><div>Loading AR sceneâ€¦</div></div>

<div id="storyBox"></div>

<div id="stepIndicator">
    <div class="step-dot"></div>
    <div class="step-dot"></div>
    <div class="step-dot"></div>
    <div class="step-dot"></div>
</div>

<div id="tapHint">Tap to continue</div>

<a-scene
        embedded
        vr-mode-ui="enabled: false"
        renderer="logarithmicDepthBuffer: true; antialias: true;"
        arjs="trackingMethod: best; sourceType: webcam; debugUIEnabled: false; maxDetectionRate: 60;"
>
    <a-assets>
        <img id="nyanImg" src="./nyan.png">
    </a-assets>

    <!-- NFT marker with strong smoothing to reduce jitter -->
    <a-nft
            id="nyanMarker"
            type="nft"
            url="./nyan-marker/nyan"
            smooth="true"
            smoothCount="20"
            smoothTolerance="0.01"
            smoothThreshold="10"
    >
        <!-- STEP 1: Nyan appears -->
        <a-entity id="step1" visible="false">
            <a-image
                    src="#nyanImg"
                    position="50 120 0"
                    rotation="-90 0 0"
                    scale="90 90 90">
            </a-image>
        </a-entity>

        <!-- STEP 2: Floating stars orbit around center -->
        <a-entity id="step2" visible="false">
            <!-- Transparent â€œorbit ringâ€ just for structure -->
            <a-entity id="starsOrbit"
                      position="50 140 0"
                      rotation="-90 0 0"
                      animation="property: rotation; to: -90 360 0; loop: true; dur: 9000; easing: linear">

                <a-sphere radius="6" color="#fffbe6" position="40 0 0"></a-sphere>
                <a-sphere radius="5" color="#ffd6ff" position="-35 10 10"></a-sphere>
                <a-sphere radius="4" color="#cce5ff" position="0 -15 30"></a-sphere>
                <a-sphere radius="3.5" color="#ffe3c2" position="-10 15 -25"></a-sphere>
                <a-sphere radius="4.5" color="#e6fff9" position="25 -5 -20"></a-sphere>
            </a-entity>

            <!-- Soft center glow -->
            <a-sphere radius="10"
                      position="50 140 0"
                      color="#ffb3ff"
                      material="emissive:#ff80d5; emissiveIntensity:0.7; opacity:0.7; transparent:true"
                      animation="property: scale; from: 0.9 0.9 0.9; to: 1.1 1.1 1.1; dir: alternate; loop: true; dur: 1500">
            </a-sphere>
        </a-entity>

        <!-- STEP 3: Small planet + ring -->
        <a-entity id="step3" visible="false">
            <a-sphere radius="55" color="#3a6eff"
                      position="50 130 0"
                      material="metalness:0.3; roughness:0.4; emissive:#1f4fd6; emissiveIntensity:0.4"
                      animation="property: rotation; to: 0 360 0; loop:true; dur: 7000;">
            </a-sphere>

            <a-torus radius="85" radius-tubular="4"
                     color="#fee77a"
                     rotation="60 0 0"
                     position="50 130 0"
                     animation="property: rotation; to: 60 360 0; loop:true; dur: 5000;">
            </a-torus>

            <a-sphere radius="10" position="-30 160 20" color="#ffd47f"></a-sphere>
            <a-sphere radius="9" position="110 150 -15" color="#ffffff"></a-sphere>
        </a-entity>

        <!-- STEP 4: Final celebration with Nyan + stars pop -->
        <a-entity id="step4" visible="false">
            <a-image
                    src="#nyanImg"
                    position="50 140 0"
                    rotation="-90 0 0"
                    scale="110 110 110"
                    animation="property: rotation; dir: alternate; from:-90 -4 0; to:-90 4 0; dur: 260; loop:true;">
            </a-image>

            <a-sphere radius="13" color="#ff4fa3" position="105 190 30"
                      animation="property: scale; dir:alternate; from:0.5 0.5 0.5; to:1.5 1.5 1.5; loop:true; dur:500;">
            </a-sphere>
            <a-sphere radius="11" color="#00f5ff" position="-25 175 40"
                      animation="property: scale; dir:alternate; from:0.5 0.5 0.5; to:1.6 1.6 1.6; loop:true; dur:600;">
            </a-sphere>
            <a-sphere radius="15" color="#ffe066" position="60 205 -15"
                      animation="property: scale; dir:alternate; from:0.5 0.5 0.5; to:1.9 1.9 1.9; loop:true; dur:450;">
            </a-sphere>
        </a-entity>
    </a-nft>

    <a-entity camera></a-entity>
</a-scene>

<script>
    const storySteps = [
        "Point the camera at the Nyan Cat image to start the AR storyâ€¦",
        "âœ¨ Nyan Cat wakes up in your reality.",
        "â­ The sky around Nyan fills with soft floating stars.",
        "ðŸª The stars swirl together and form a tiny planet.",
        "ðŸŽ‰ Nyan celebrates your journey through this mini universe!"
    ];

    let currentStep = 0;
    let markerSeen = false;

    const storyBox = document.getElementById("storyBox");
    const tapHint = document.getElementById("tapHint");
    const stepIndicator = document.getElementById("stepIndicator");
    const dots = document.querySelectorAll(".step-dot");
    const loader = document.querySelector(".arjs-loader");

    const stepEntities = [
        null,
        document.getElementById("step1"),
        document.getElementById("step2"),
        document.getElementById("step3"),
        document.getElementById("step4")
    ];

    function showStep(i) {
        currentStep = i;
        storyBox.textContent = storySteps[i];
        storyBox.classList.add("visible");
        stepIndicator.classList.add("visible");

        // Update dots
        dots.forEach((dot, idx) => {
            dot.classList.toggle("active", idx <= i);
        });

        // Show only current 3D group
        stepEntities.forEach((ent, idx) => {
            if (!ent) return;
            ent.setAttribute("visible", idx === i);
        });

        if (i < storySteps.length - 1) {
            tapHint.classList.add("visible");
        } else {
            tapHint.classList.remove("visible");
        }
    }

    function nextStep() {
        if (currentStep < storySteps.length - 1) {
            tapHint.classList.remove("visible");
            showStep(currentStep + 1);
        }
    }

    const marker = document.getElementById("nyanMarker");

    marker.addEventListener("markerFound", () => {
        loader.style.display = "none";
        if (!markerSeen) {
            markerSeen = true;
            // Start directly from step 1 (Nyan appears)
            showStep(1);
        }
    });

    // We don't hide content on markerLost â†’ helps avoid flicker.
    marker.addEventListener("markerLost", () => {
        // Do nothing here to keep last pose & objects,
        // smoothing will reduce flicker.
    });

    document.body.addEventListener("click", () => {
        if (markerSeen && currentStep >= 1) {
            nextStep();
        }
    });
</script>

</body>
</html>
